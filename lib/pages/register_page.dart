import 'package:calendario/componentes/my_button.dart';
import 'package:calendario/componentes/my_textfield.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:flutter/material.dart';
import 'package:flutter_svg/flutter_svg.dart';
import '../screens/home_screen.dart'; // üîë A√±adida importaci√≥n para navegar a HomeScreen

class RegisterPage extends StatefulWidget {
  final Function()? onTap;
  const RegisterPage({super.key, required this.onTap});

  @override
  State<RegisterPage> createState() => _RegisterPageState();
}

class _RegisterPageState extends State<RegisterPage> {
  // text editing controllers
  final emailController = TextEditingController();
  final passwordController = TextEditingController();
  final confirmPasswordController = TextEditingController();

  // NUEVO: Estado para el checkbox de t√©rminos y condiciones
  bool _agreedToTerms = false;

  // ------------------------------------------------------------------
  // FUNCI√ìN: Muestra mensajes de error al usuario (fondo morado)
  // ------------------------------------------------------------------
  void showErrorMessage(String message) {
    if (!mounted) return; // üîë Chequeo de seguridad al inicio
    
    showDialog(
      context: context,
      barrierDismissible: true, // Permitir cerrar al tocar fuera
      builder: (context) {
        return AlertDialog(
          backgroundColor: Colors.deepPurple,
          title: const Center(
            child: Text(
              "Error de Registro", // T√≠tulo en espa√±ol para el di√°logo
              style: TextStyle(
                color: Colors.white,
                fontWeight: FontWeight.bold,
              ),
            ),
          ),
          content: Text(
            message,
            textAlign: TextAlign.center,
            style: const TextStyle(color: Colors.white, fontSize: 16),
          ),
          // Se han eliminado las acciones (el bot√≥n "Aceptar")
        );
      },
    );
  }

  // ------------------------------------------------------------------
  // FUNCI√ìN: Mostrar mensaje de √©xito (fondo verde)
  // ------------------------------------------------------------------
  void showSuccessMessage(String message) {
    if (!mounted) return; // üîë Chequeo de seguridad al inicio
    
    showDialog(
      context: context,
      barrierDismissible: true, // Permitir cerrar al tocar fuera
      builder: (dialogContext) { // Usamos 'dialogContext' para evitar ambig√ºedad
        
        // Cierra el di√°logo y NAVEGA autom√°ticamente despu√©s de un peque√±o delay
        Future.delayed(const Duration(milliseconds: 500), () {
          if (mounted) {
            // Cierra el di√°logo
            Navigator.pop(dialogContext); 
            
            // NAVEGACI√ìN A HOME SCREEN DESPU√âS DEL √âXITO
            Navigator.pushReplacement(
              context,
              MaterialPageRoute(builder: (context) => const HomeScreen()), 
            );
          }
        });
        
        return AlertDialog(
          backgroundColor: Colors.green, // Color verde para indicar √©xito
          title: const Center(
            child: Text(
              "Registro Exitoso", // T√≠tulo de √©xito
              style: TextStyle(
                color: Colors.white,
                fontWeight: FontWeight.bold,
              ),
            ),
          ),
          content: Text(
            message,
            textAlign: TextAlign.center,
            style: const TextStyle(color: Colors.white, fontSize: 16),
          ),
        );
      },
    );
  }

  // ------------------------------------------------------------------
  // FUNCI√ìN: Muestra el di√°logo de T√©rminos y Condiciones
  // ------------------------------------------------------------------
  void _showTermsAndConditionsDialog() {
    if (!mounted) return; // üîë Chequeo de seguridad
    
    showDialog(
      context: context,
      barrierDismissible: true,
      builder: (context) {
        return AlertDialog(
          backgroundColor: Colors.white,
          title: const Text(
            "T√©rminos y Condiciones",
            style: TextStyle(fontWeight: FontWeight.bold, color: Colors.deepPurple),
          ),
          content: SingleChildScrollView(
            child: Text(
              "Gracias por usar Remind. Al crear una cuenta, usted acepta los siguientes t√©rminos:\n\n"
              "*1. Aceptaci√≥n de T√©rminos:* El uso de la aplicaci√≥n implica la aceptaci√≥n total de estos t√©rminos, los cuales pueden ser actualizados sin previo aviso.\n\n"
              "*2. Privacidad:* Sus datos (correo y contrase√±a) se almacenan de forma segura mediante Firebase Authentication y no ser√°n compartidos con terceros sin su consentimiento, excepto por requerimiento legal.\n\n"
              "*3. Uso Adecuado:* La aplicaci√≥n debe ser utilizada para fines l√≠citos y personales. Queda prohibido el uso indebido o malicioso del servicio.\n\n"
              "*4. Limitaci√≥n de Responsabilidad:* No somos responsables por p√©rdidas o da√±os derivados del uso o la incapacidad de usar la aplicaci√≥n.\n\n"
              "Presiona fuera del cuadro para cerrar.",
              style: TextStyle(color: Colors.grey[800], fontSize: 14),
            ),
          ),
        );
      },
    );
  }

  // ------------------------------------------------------------------
  // M√âTODO PRINCIPAL: sign user up method
  // ------------------------------------------------------------------
  void signUserUp() async {
    // 0. VALIDACI√ìN DE ACEPTACI√ìN DE T√âRMINOS
    if (!_agreedToTerms) {
      showErrorMessage("Debes aceptar los T√©rminos y Condiciones para registrarte.");
      return;
    }

    // 1. VALIDACI√ìN DE CAMPOS VAC√çOS
    if (emailController.text.isEmpty ||
        passwordController.text.isEmpty ||
        confirmPasswordController.text.isEmpty) {
      showErrorMessage("Por favor, rellena todos los campos.");
      return;
    }

    // MOSTRAR LA RUEDA DE CARGA
    if (!mounted) return; // Chequeo antes de usar context para showDialog
    showDialog(
      context: context,
      barrierDismissible: false, // Evita que se cierre al tocar fuera
      builder: (context) {
        return const Center(
          child: CircularProgressIndicator(color: Colors.deepPurple),
        );
      },
    );

    // Intentar crear el usuario
    try {
      // 2. Verificar si las contrase√±as coinciden
      if (passwordController.text != confirmPasswordController.text){
        
        // üîë CORRECCI√ìN DE LA L√çNEA 152: Uso del context despu√©s de await/l√≥gica.
        if (mounted) {
          Navigator.pop(context); // Cierra la rueda de carga
          showErrorMessage("Las contrase√±as no coinciden.");
        }
        return; // Detener la funci√≥n
      }

      // 3. Crear el usuario en Firebase
      await FirebaseAuth.instance.createUserWithEmailAndPassword(
        email: emailController.text,
        password: passwordController.text,
      );

      // Si es exitoso, quitar la rueda de carga y mostrar mensaje.
      // üîë CORRECCI√ìN DE LA L√çNEA 159: Uso del context despu√©s de await/l√≥gica.
      if (mounted) {
        Navigator.pop(context);
        showSuccessMessage("Cuenta registrada correctamente.");
      }

    } on FirebaseAuthException catch (e) {
      
      // Manejo de errores de Firebase
      if (mounted) {
        // Quitar la rueda de carga
        Navigator.pop(context);

        String errorMessage;
        // Traducir los c√≥digos de error comunes de Firebase
        switch (e.code) {
          case 'weak-password':
            errorMessage = 'La contrase√±a es demasiado d√©bil. Debe tener al menos 6 caracteres.';
            break;
          case 'email-already-in-use':
            errorMessage = 'El correo electr√≥nico ya est√° registrado.';
            break;
          case 'invalid-email':
            errorMessage = 'El formato del correo electr√≥nico es inv√°lido.';
            break;
          case 'operation-not-allowed':
            errorMessage = 'El registro de usuarios est√° deshabilitado temporalmente.';
            break;
          default:
            errorMessage = 'Ocurri√≥ un error inesperado. C√≥digo: ${e.code}';
            break;
        }
        showErrorMessage(errorMessage);
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: const Color.fromARGB(255, 255, 255, 255),
      body: SafeArea(
        child: Center(
          child: SingleChildScrollView( // Usar SingleChildScrollView para evitar desbordamiento
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                const SizedBox(height: 25),

                SvgPicture.asset(
                  'remi2.svg',
                  height: 150, // Ajustar la altura
                ),

                const SizedBox(height: 25),

                // üîë NUEVO TEXTO: ¬°Hola, te damos la bienvenida a Remind!
                Text(
                  '¬°Hola, te damos la bienvenida a Remind!',
                  textAlign: TextAlign.center,
                  style: TextStyle(
                    color: Colors.grey[700],
                    fontSize: 22, // Tama√±o m√°s grande que el original (20)
                    fontWeight: FontWeight.bold, // Texto en negritas
                  ),
                ),

                const SizedBox(height: 30),

                // ‚ùå ELIMINADO: logo remi (remi.png)

                // üîë NUEVO TEXTO DE INSTRUCCI√ìN (Reemplaza el texto '¬°Reg√≠strate')
                Text(
                  'Ingresa tu correo electr√≥nico para comenzar',
                  style: TextStyle(
                    color: Colors.grey[700],
                    // Tama√±o similar a un hintText (el que usa MyTextField)
                    fontSize: 16, 
                  ),
                ),
                
                const SizedBox(height: 30),

                // username textfield
                MyTextField(
                  controller: emailController,
                  hintText: 'Ingresar correo electr√≥nico', // Correcci√≥n de acento
                  obscureText: false,
                ),

                const SizedBox(height: 10),

                // password textfield
                MyTextField(
                  controller: passwordController,
                  hintText: 'Ingresar contrase√±a',
                  obscureText: true,
                ),

                const SizedBox(height: 10),

                // confirm password textfield
                MyTextField(
                  controller: confirmPasswordController,
                  hintText: 'Confirmar contrase√±a',
                  obscureText: true,
                ),

                const SizedBox(height: 15),

                // NUEVO: Checkbox de T√©rminos y Condiciones
                Padding(
                  padding: const EdgeInsets.symmetric(horizontal: 25.0),
                  child: Row(
                    children: [
                      Checkbox(
                        value: _agreedToTerms,
                        onChanged: (newValue) {
                          setState(() {
                            _agreedToTerms = newValue!;
                          });
                        },
                        activeColor: const Color.fromARGB(255, 58, 183, 100),
                      ),
                      Text(
                        'Acepto los ',
                        style: TextStyle(color: Colors.grey[700], fontSize: 14),
                      ),
                      GestureDetector(
                        onTap: _showTermsAndConditionsDialog, // Llama al di√°logo
                        child: const Text(
                          'T√©rminos y condiciones',
                          style: TextStyle(
                            color: Colors.blue, // Palabra clave en azul
                            fontWeight: FontWeight.bold,
                            decoration: TextDecoration.underline,
                            fontSize: 14,
                          ),
                        ),
                      ),
                    ],
                  ),
                ),

                const SizedBox(height: 25),

                // sign in button
                MyButton(
                  text: "Registrarse", // Cambio a may√∫scula
                  onTap: signUserUp,
                ),

                const SizedBox(height: 50),

                // already a member? login now
                Row(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    Text(
                      '¬øYa tienes una cuenta?', // Texto m√°s natural
                      style: TextStyle(color: Colors.grey[700]),
                    ),
                    const SizedBox(width: 4),
                    GestureDetector(
                      onTap: widget.onTap,
                      child: const Text(
                        'Iniciar sesi√≥n', // Cambio de texto
                        style: TextStyle(
                          color: Colors.blue,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 25),
              ],
            ),
          ),
        ),
      ),
    );
  }
}